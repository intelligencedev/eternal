<style>
  .loadership_JTACT {
    display: flex;
    position: relative;
    width: 68px;
    height: 68px;
  }

  .loadership_JTACT div {
    animation: loadership_JTACT_roller 1.2s infinite;
    animation-timing-function: cubic-bezier(0.5, 0, 0.5, 1);
    transform-origin: 34px 34px;
  }

  .loadership_JTACT div:after {
    content: " ";
    display: block;
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #ffffff;
  }

  .loadership_JTACT div:nth-child(1) {
    animation-delay: 0.00s;
  }

  .loadership_JTACT div:nth-child(1):after {
    top: 60px;
    left: 30px;
  }


  .loadership_JTACT div:nth-child(2) {
    animation-delay: -0.04s;
  }

  .loadership_JTACT div:nth-child(2):after {
    top: 56px;
    left: 45px;
  }


  .loadership_JTACT div:nth-child(3) {
    animation-delay: -0.07s;
  }

  .loadership_JTACT div:nth-child(3):after {
    top: 45px;
    left: 56px;
  }


  .loadership_JTACT div:nth-child(4) {
    animation-delay: -0.11s;
  }

  .loadership_JTACT div:nth-child(4):after {
    top: 30px;
    left: 60px;
  }


  .loadership_JTACT div:nth-child(5) {
    animation-delay: -0.14s;
  }

  .loadership_JTACT div:nth-child(5):after {
    top: 15px;
    left: 56px;
  }


  .loadership_JTACT div:nth-child(6) {
    animation-delay: -0.18s;
  }

  .loadership_JTACT div:nth-child(6):after {
    top: 4px;
    left: 45px;
  }


  .loadership_JTACT div:nth-child(7) {
    animation-delay: -0.22s;
  }

  .loadership_JTACT div:nth-child(7):after {
    top: 0px;
    left: 30px;
  }


  .loadership_JTACT div:nth-child(8) {
    animation-delay: -0.25s;
  }

  .loadership_JTACT div:nth-child(8):after {
    top: 4px;
    left: 15px;
  }


  .loadership_JTACT div:nth-child(9) {
    animation-delay: -0.29s;
  }

  .loadership_JTACT div:nth-child(9):after {
    top: 15px;
    left: 4px;
  }


  .loadership_JTACT div:nth-child(10) {
    animation-delay: -0.32s;
  }

  .loadership_JTACT div:nth-child(10):after {
    top: 30px;
    left: 0px;
  }


  .loadership_JTACT div:nth-child(11) {
    animation-delay: -0.36s;
  }

  .loadership_JTACT div:nth-child(11):after {
    top: 45px;
    left: 4px;
  }


  .loadership_JTACT div:nth-child(12) {
    animation-delay: -0.40s;
  }

  .loadership_JTACT div:nth-child(12):after {
    top: 56px;
    left: 15px;
  }



  @keyframes loadership_JTACT_roller {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>

<div name="chat-{{.turnID}}" id="chat-{{.turnID}}" hx-ext="ws" ws-connect="{{.wsRoute}}">
  <!-- <div name="chat-{{.turnID}}" id="chat-{{.turnID}}"> -->
  <div class="row">
    <div id="prompt-{{.turnID}}" class="user-prompt rounded-2 mt-3 pb-3">
      <div>
        <span class="badge my-3 mx-1" style="background-color: var(--et-red);">{{.username}}</span>
      </div>
      <!-- Using a hidden form to send the message -->
      <form id="hidden-form-{{.turnID}}" style="display:none;" hx-trigger="load" ws-send>
        <!-- <form id="hidden-form-{{.turnID}}" style="display:none;" hx-trigger="load">   -->
        <!-- Get the selectedModels in localStorage and send over websocket -->
        <input type="hidden" name="model" value="{{.model}}">
        <input type="hidden" name="chat_message" value="{{.message}}">
      </form>
      <div>
        <span class="message-content mx-1">{{.message}}</span>
      </div>
    </div>
  </div>
  <div class="row">
    <div id="response-{{.turnID}}" class="response rounded-2 mt-3 pb-3 overflow-y-auto">
      <div>
        <span class="badge my-3 mx-1" style="background-color: var(--et-purple);">{{.assistant}}</span>
      </div>
      <!-- Messages received from WebSocket will be appended here -->
      <div name="chat-{{.turnID}}" id="response-content-{{.turnID}}" hx-trigger="load, customEndOfStream"
        hx-on:load="highlight()">
        <div class="loadership_JTACT">
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
          <div></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- <codapi-settings url="http://localhost:1313/v1"></codapi-settings> -->
<script src="js/node_modules/@antonz/codapi/dist/snippet.js"></script>
<script>
  htmx.on("htmx:wsOpen", function (evt) {
    console.log("WebSocket opened");
    const box = document.querySelector(".box");
    if (box) {
      box.style.transition = "transform 0.5s ease";

      // Restore original rotation
      box.style.transform = "rotateX(45deg) rotateY(45deg) rotateZ(-180deg)";
    }
  });

  htmx.on("htmx:wsOnClose", function (evt) {
    console.log("WebSocket closed");
    highlight();
    const box = document.querySelector(".box");
    const newRotation = getRandomRotation();
    box.style.transition = "transform 0.5s ease";
    box.style.transform = newRotation;
  });

  function scrollToBottom() {
    setTimeout(function () {
      window.scrollTo(0, document.body.scrollHeight);
    }, 0); // Timeout ensures the DOM has been painted
  }

  // Call scrollToBottom in the htmx event handlers
  htmx.on("htmx:wsAfterMessage", function (evt) {
    const box = document.querySelector(".box");
    const newRotation = chatRotation();
    box.style.transition = "transform 0.2s ease";
    box.style.transform = newRotation;
    setViewHeight("prompt-view");
    highlight();
    scrollToBottom();
  });

  // Highlight code blocks
  function highlight() {
    const container = document.getElementById("response-content-{{.turnID}}");
    container.querySelectorAll('pre code').forEach((block, index) => {
      if (!block.hasAttribute('data-snippet-added')) {
        hljs.highlightElement(block);

        block.classList.add('rounded-2');

        // Create a new snippet element only if not already added
        const snippet = document.createElement('codapi-snippet');
        snippet.setAttribute('url', 'http://localhost:1313/v1');
        snippet.setAttribute('engine', 'browser');
        snippet.setAttribute('sandbox', 'javascript');
        snippet.setAttribute('editor', 'basic');

        // Create a button to copy code
        const copyButton = document.createElement('button');
        copyButton.classList.add('btn', 'btn-link');
        copyButton.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <path fill="#FFFFFF" fill-rule="evenodd" d="M7.263 3.26A2.25 2.25 0 0 1 9.5 1.25h5a2.25 2.25 0 0 1 2.237 2.01c.764.016 1.423.055 1.987.159c.758.14 1.403.404 1.928.93c.602.601.86 1.36.982 2.26c.116.866.116 1.969.116 3.336v6.11c0 1.367 0 2.47-.116 3.337c-.122.9-.38 1.658-.982 2.26c-.602.602-1.36.86-2.26.982c-.867.116-1.97.116-3.337.116h-6.11c-1.367 0-2.47 0-3.337-.116c-.9-.122-1.658-.38-2.26-.982c-.602-.602-.86-1.36-.981-2.26c-.117-.867-.117-1.97-.117-3.337v-6.11c0-1.367 0-2.47.117-3.337c.12-.9.38-1.658.981-2.26c.525-.525 1.17-.79 1.928-.929c.564-.104 1.224-.143 1.987-.159Zm1.487.741V4.5c0 .414.336.75.75.75h5a.75.75 0 0 0 .75-.75v-1a.75.75 0 0 0-.75-.75h-5a.75.75 0 0 0-.75.75v.501Zm7.985.76A2.25 2.25 0 0 1 14.5 6.75h-5a2.25 2.25 0 0 1-2.235-1.99c-.718.016-1.272.052-1.718.134c-.566.104-.895.272-1.138.515c-.277.277-.457.665-.556 1.4c-.101.754-.103 1.756-.103 3.191v6c0 1.435.002 2.436.103 3.192c.099.734.28 1.122.556 1.399c.277.277.665.457 1.4.556c.754.101 1.756.103 3.191.103h6c1.435 0 2.436-.002 3.192-.103c.734-.099 1.122-.28 1.399-.556c.277-.277.457-.665.556-1.4c.101-.755.103-1.756.103-3.191v-6c0-1.435-.002-2.437-.103-3.192c-.099-.734-.28-1.122-.556-1.399c-.244-.243-.572-.41-1.138-.515c-.446-.082-1-.118-1.718-.133ZM6.25 14.5a.75.75 0 0 1 .75-.75h8a.75.75 0 0 1 0 1.5H7a.75.75 0 0 1-.75-.75Zm0 3.5a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 0 1.5H7a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd"/>
        </svg>`;
        copyButton.onclick = function () {
          navigator.clipboard.writeText(block.textContent).then(() => {
            alert('Code copied to clipboard!');
          }, () => {
            alert('Failed to copy code.');
          });
        };

        // Insert the snippet and the button after the code block
        const wrapper = document.createElement('div');
        wrapper.setAttribute('id', 'snippet-wrapper');
        wrapper.classList.add('rounded-2', 'mb-3');
        // Add background color to the wrapper rgb #272822
        wrapper.style.backgroundColor = '#272822';
        wrapper.appendChild(snippet);
        wrapper.appendChild(copyButton);

        block.parentNode.insertAdjacentElement('afterend', wrapper);

        // Mark this code block as having a snippet added
        block.setAttribute('data-snippet-added', 'true');
      }
    });
  }
</script>